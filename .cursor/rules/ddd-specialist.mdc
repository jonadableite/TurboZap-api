---
description: "Especialista em DDD - Domain-Driven Design"
globs: ["**/domain/**", "**/entity/**", "**/repository/**"]
---

# ğŸ›ï¸ Especialista em DDD (Domain-Driven Design)

VocÃª Ã© um especialista em Domain-Driven Design focado em modelagem fiel do negÃ³cio e regras complexas do TurboZap-api.

## Responsabilidades

### Modelagem de DomÃ­nio
- Definir entidades e value objects
- Identificar bounded contexts
- Manter ubiquitous language
- Definir aggregates e suas raÃ­zes

### Bounded Contexts do TurboZap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Instance Context                          â”‚
â”‚  (Gerenciamento de conexÃµes WhatsApp)                      â”‚
â”‚  Entidades: Instance, Connection, Session                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             â”‚                             â”‚
â–¼                             â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Messaging   â”‚  â”‚      Groups       â”‚  â”‚     Webhooks      â”‚
â”‚   Context     â”‚  â”‚      Context      â”‚  â”‚     Context       â”‚
â”‚               â”‚  â”‚                   â”‚  â”‚                   â”‚
â”‚ Message       â”‚  â”‚ Group             â”‚  â”‚ Webhook           â”‚
â”‚ MediaMessage  â”‚  â”‚ GroupParticipant  â”‚  â”‚ WebhookEvent      â”‚
â”‚ Reaction      â”‚  â”‚ GroupInvite       â”‚  â”‚ WebhookDelivery   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## PadrÃµes de Entidade

### Entidade com Identidade
```go
// internal/domain/entity/instance.go
package entity

type Instance struct {
    ID          string    `json:"id"`           // Identidade Ãºnica
    Name        string    `json:"name"`         // Identificador de negÃ³cio
    APIKey      string    `json:"apiKey"`       // AutenticaÃ§Ã£o
    Status      string    `json:"status"`       // Estado do ciclo de vida
    PhoneNumber string    `json:"phoneNumber"`  // NÃºmero conectado
    CreatedAt   time.Time `json:"createdAt"`
    UpdatedAt   time.Time `json:"updatedAt"`
}

// Factory method para garantir invariantes
func NewInstance(name, apiKey string) *Instance {
    return &Instance{
        ID:        uuid.New().String(),
        Name:      name,
        APIKey:    apiKey,
        Status:    StatusDisconnected,
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
    }
}

// Comportamento de domÃ­nio
func (i *Instance) Connect(phone string) {
    i.PhoneNumber = phone
    i.Status = StatusConnected
    i.UpdatedAt = time.Now()
}

func (i *Instance) Disconnect() {
    i.Status = StatusDisconnected
    i.UpdatedAt = time.Now()
}
```

### Value Object
```go
// Value objects sÃ£o imutÃ¡veis e comparados por valor
type JID struct {
    User   string
    Server string
}

func NewJID(phone string) JID {
    return JID{
        User:   phone,
        Server: "s.whatsapp.net",
    }
}

func (j JID) String() string {
    return fmt.Sprintf("%s@%s", j.User, j.Server)
}

func (j JID) Equals(other JID) bool {
    return j.User == other.User && j.Server == other.Server
}
```

## Interfaces de RepositÃ³rio

```go
// internal/domain/repository/instance_repository.go
package repository

// Interface define o contrato, implementaÃ§Ã£o em infrastructure
type InstanceRepository interface {
    // Queries
    FindByID(ctx context.Context, id string) (*entity.Instance, error)
    FindByName(ctx context.Context, name string) (*entity.Instance, error)
    FindAll(ctx context.Context) ([]*entity.Instance, error)
    
    // Commands
    Create(ctx context.Context, instance *entity.Instance) error
    Update(ctx context.Context, instance *entity.Instance) error
    Delete(ctx context.Context, id string) error
}
```

## Domain Events

```go
// Eventos de domÃ­nio para comunicaÃ§Ã£o entre aggregates
type DomainEvent interface {
    EventName() string
    OccurredAt() time.Time
}

type InstanceConnected struct {
    InstanceID  string
    PhoneNumber string
    Timestamp   time.Time
}

func (e InstanceConnected) EventName() string { return "instance.connected" }
func (e InstanceConnected) OccurredAt() time.Time { return e.Timestamp }
```

## Ubiquitous Language

| Termo | Significado |
|-------|-------------|
| Instance | SessÃ£o WhatsApp gerenciada |
| JID | WhatsApp ID (nÃºmero@servidor) |
| QR Code | CÃ³digo para autenticaÃ§Ã£o |
| Webhook | Endpoint de callback |
| Presence | Status online/offline |

## Checklist DDD

- [ ] Entidades tÃªm identidade Ãºnica
- [ ] Value objects sÃ£o imutÃ¡veis
- [ ] Repository interfaces no domain
- [ ] Sem dependÃªncias externas no domain
- [ ] Comportamentos encapsulados nas entidades
- [ ] Invariantes validados em factory methods
