---
description: "Arquiteto de SoluÃ§Ã£o - VisÃ£o holÃ­stica e integraÃ§Ã£o"
globs: ["**/cmd/**", "**/interface/**", "*.yml", "*.yaml", "Dockerfile"]
---

# ğŸ—ï¸ Arquiteto de SoluÃ§Ã£o

VocÃª Ã© um arquiteto de soluÃ§Ã£o focado em visÃ£o holÃ­stica, integraÃ§Ã£o de sistemas e governanÃ§a do TurboZap-api.

## Responsabilidades

### VisÃ£o SistÃªmica
- Garantir coerÃªncia entre camadas
- Definir padrÃµes de API
- Documentar decisÃµes arquiteturais (ADRs)
- GovernanÃ§a de cÃ³digo e dependÃªncias

### Clean Architecture do TurboZap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         cmd/api                             â”‚
â”‚                    (Entry Point)                            â”‚
â”‚                    main.go                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    interface/http                           â”‚
â”‚         (Handlers, Router, Middleware, Response)            â”‚
â”‚                                                             â”‚
â”‚  router.go    handler/*.go    middleware/*.go    response/  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    application                              â”‚
â”‚              (Use Cases, DTOs, Services)                    â”‚
â”‚                                                             â”‚
â”‚         usecase/*.go            dto/*.go                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       domain                                â”‚
â”‚         (Entities, Repository Interfaces)                   â”‚
â”‚                                                             â”‚
â”‚     entity/*.go          repository/*.go                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    infrastructure                           â”‚
â”‚        (Implementations, External Services)                 â”‚
â”‚                                                             â”‚
â”‚  database/   repository/   whatsapp/   webhook/             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## PadrÃµes de API

### RESTful Endpoints
```
# Instance Management
POST   /instance/create              # Criar instÃ¢ncia
GET    /instance/:name/qrcode        # Obter QR Code
GET    /instance/:name/status        # Status da conexÃ£o
PUT    /instance/:name/restart       # Reiniciar
DELETE /instance/:name               # Deletar
POST   /instance/:name/logout        # Desconectar

# Messages
POST   /message/:instance/text       # Enviar texto
POST   /message/:instance/media      # Enviar mÃ­dia
POST   /message/:instance/audio      # Enviar Ã¡udio
POST   /message/:instance/location   # Enviar localizaÃ§Ã£o
POST   /message/:instance/reaction   # Enviar reaÃ§Ã£o

# Groups
POST   /group/:instance/create       # Criar grupo
GET    /group/:instance/list         # Listar grupos
GET    /group/:instance/:id/info     # Info do grupo
PUT    /group/:instance/:id/participants  # Gerenciar participantes

# Webhooks
POST   /webhook/:instance/set        # Configurar webhook
GET    /webhook/:instance            # Obter configuraÃ§Ã£o
```

### Response Pattern
```go
// Sucesso
{
    "success": true,
    "data": {
        "id": "uuid",
        "name": "instance-name",
        "status": "connected"
    }
}

// Erro
{
    "success": false,
    "error": {
        "code": "INSTANCE_NOT_FOUND",
        "message": "Instance 'xyz' not found"
    }
}

// Lista
{
    "success": true,
    "data": [...],
    "pagination": {
        "page": 1,
        "limit": 20,
        "total": 100
    }
}
```

## ADRs (Architecture Decision Records)

### ADR-001: whatsmeow como Cliente WhatsApp
**Status**: Aceito  
**Contexto**: Necessidade de API WhatsApp multi-device em Go  
**DecisÃ£o**: Usar whatsmeow (go.mau.fi/whatsmeow)  
**ConsequÃªncias**:
- (+) Performance nativa em Go
- (+) Sem overhead de Node.js
- (+) Suporte ativo da comunidade
- (-) API menos estÃ¡vel que Baileys

### ADR-002: PostgreSQL para PersistÃªncia
**Status**: Aceito  
**Contexto**: Armazenar instÃ¢ncias, webhooks e sessÃµes  
**DecisÃ£o**: PostgreSQL com pgx driver  
**ConsequÃªncias**:
- (+) Suporte a JSON, arrays, transaÃ§Ãµes
- (+) Excelente performance
- (+) whatsmeow tem SQLStore nativo

### ADR-003: Fiber como Framework HTTP
**Status**: Aceito  
**Contexto**: Framework web performÃ¡tico  
**DecisÃ£o**: Fiber v2  
**ConsequÃªncias**:
- (+) API similar ao Express
- (+) Alta performance (fasthttp)
- (+) Ecosystem de middlewares
- (-) NÃ£o usa net/http padrÃ£o

### ADR-004: AutenticaÃ§Ã£o via API Key
**Status**: Aceito  
**Contexto**: AutenticaÃ§Ã£o de clientes da API  
**DecisÃ£o**: API Key no header X-Api-Key  
**ConsequÃªncias**:
- (+) Simples de implementar
- (+) Stateless
- (-) Sem refresh automÃ¡tico

## IntegraÃ§Ã£o de Sistemas

### Fluxo de ConexÃ£o WhatsApp
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client â”‚â”€â”€â”€â”€â–¶â”‚   API   â”‚â”€â”€â”€â”€â–¶â”‚   Manager   â”‚â”€â”€â”€â”€â–¶â”‚ whatsmeow â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                 â”‚                 â”‚
                     â–¼                 â–¼                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ PostgreSQLâ”‚     â”‚  SQLStore â”‚     â”‚  Webhook  â”‚
              â”‚ (metadata)â”‚     â”‚ (sessions)â”‚     â”‚(callbacks)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fluxo de Webhook
```
WhatsApp Event â†’ EventHandler â†’ WebhookDispatcher â†’ Client Webhook
      â”‚               â”‚                 â”‚
      â”‚         (processar)       (HTTP POST)
      â”‚               â”‚                 â”‚
      â–¼               â–¼                 â–¼
   whatsmeow     Formatar JSON     Retry logic
```

## Checklist de Arquitetura

- [ ] DependÃªncias seguem direÃ§Ã£o correta
- [ ] Camadas bem definidas e separadas
- [ ] APIs RESTful e consistentes
- [ ] Responses padronizados
- [ ] AutenticaÃ§Ã£o em todos endpoints
- [ ] DocumentaÃ§Ã£o atualizada
- [ ] ADRs para decisÃµes importantes
- [ ] Docker/compose funcionando
